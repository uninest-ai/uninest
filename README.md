# **HW4 Handout**

In this assignment, we are introducing a new format for assignment delivery, designed to enhance your development workflow. The key motivations for this change are:

- **Test Suite Integration**: Your code will be tested in a manner similar to `HWP1's`.
- **Local Development**: You will be able to perform most of your initial development locally, reducing the need for compute resources.
- **Hands-on Experience**: This assignment provides an opportunity to build an end-to-end deep learning pipeline from scratch. We will be substantially reducing the amount of abstractions compared to previous assignments.

For our provided notebook's to work, your notebook's current working directory must be the same as the handout.
This is important because the relative imports in the notebook's depend on the current working directory.
This can be achieved by:

1. Physically moving the notebook's into the handout directory.
2. Changing the notebook's current working directory to the handout directory using the `os.chdir()` function.

Your current working directory should have the following files for this assignment:

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ hw4lib/
‚îú‚îÄ‚îÄ mytorch/
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ hw4_data_subset/
‚îî‚îÄ‚îÄ requirements.txt
```

## üìä Dataset Structure

We have provided a subset of the dataset for you to use. This subset has been provided with the intention of allowing you to implement and test your code locally. The subset follows the same structure as the original dataset and is organized as follows:

```
hw4_data_subset/
‚îú‚îÄ‚îÄ hw4p1_data/ # For causal language modeling
‚îÇ ‚îú‚îÄ‚îÄ train/
‚îÇ ‚îú‚îÄ‚îÄ valid/
‚îÇ ‚îî‚îÄ‚îÄ test/
‚îî‚îÄ‚îÄ hw4p2_data/ # For end-to-end speech recognition
‚îú‚îÄ‚îÄ dev-clean/
‚îÇ ‚îú‚îÄ‚îÄ fbank/
‚îÇ ‚îî‚îÄ‚îÄ text/
‚îú‚îÄ‚îÄ test-clean/
‚îÇ ‚îî‚îÄ‚îÄ fbank/
‚îî‚îÄ‚îÄ train-clean-100/
‚îú‚îÄ‚îÄ fbank/
‚îî‚îÄ‚îÄ text/

```

## üîß Implementation Files

### Main Library (`hw4lib/`)

For `HW4P1` and `HW4P2`, you will incrementally implement components of `hw4lib` to build and train two models:

- **HW4P1**: A _Decoder-only Transformer_ for causal language modeling.
- **HW4P2**: An _Encoder-Decoder Transformer_ for end-to-end speech recognition.

Many of the components you implement will be reusable across both parts, reinforcing modular design and efficient implementation. You should see the following files in the `hw4lib/` directory (`__init__.py`'s are not shown):

```
hw4lib/
‚îú‚îÄ‚îÄ data/
‚îÇ ‚îú‚îÄ‚îÄ tokenizer_jsons/
‚îÇ ‚îú‚îÄ‚îÄ asr_dataset.py
‚îÇ ‚îú‚îÄ‚îÄ lm_dataset.py
‚îÇ ‚îî‚îÄ‚îÄ tokenizer.py
‚îú‚îÄ‚îÄ decoding/
‚îÇ ‚îî‚îÄ‚îÄ sequence_generator.py
‚îú‚îÄ‚îÄ model/
‚îÇ ‚îú‚îÄ‚îÄ masks.py
‚îÇ ‚îú‚îÄ‚îÄ positional_encoding.py
‚îÇ ‚îú‚îÄ‚îÄ speech_embedding.py
‚îÇ ‚îú‚îÄ‚îÄ sublayers.py
‚îÇ ‚îú‚îÄ‚îÄ decoder_layers.py
‚îÇ ‚îú‚îÄ‚îÄ encoder_layers.py
‚îÇ ‚îî‚îÄ‚îÄ transformers.py
‚îú‚îÄ‚îÄ trainers/
‚îÇ  ‚îú‚îÄ‚îÄ base_trainer.py
‚îÇ  ‚îú‚îÄ‚îÄ asr_trainer.py
‚îÇ  ‚îî‚îÄ‚îÄ lm_trainer.py
‚îî‚îÄ‚îÄ utils/
   ‚îú‚îÄ‚îÄ create_lr_scheduler.py
   ‚îî‚îÄ‚îÄ create_optimizer.py
```

### MyTorch Library Components (`mytorch/`)

In `HW4P1` and `HW4P2`, you will build and train Transformer models using PyTorch‚Äôs `nn.MultiHeadAttention`. To deepen your understanding of its internals, you will also implement a custom `MultiHeadAttention` module from scratch as part of your `mytorch` library, designed to closely match the PyTorch interface. You should see the following files in the `mytorch/` directory:

```

mytorch/nn/
‚îú‚îÄ‚îÄ activation.py
‚îú‚îÄ‚îÄ linear.py
‚îú‚îÄ‚îÄ scaled_dot_product_attention.py
‚îî‚îÄ‚îÄ multi_head_attention.py

```

### Test Suite (`tests/`)

In `HW4P1` and `HW4P2`, you will be provided with a test suite that will be used to test your implementation. You should see the following files in the `tests/` directory:

```

tests/
‚îú‚îÄ‚îÄ testing_framework.py
‚îú‚îÄ‚îÄ test_mytorch*.py
‚îú‚îÄ‚îÄ test_dataset*.py
‚îú‚îÄ‚îÄ test_mask*.py
‚îú‚îÄ‚îÄ test_positional_encoding.py
‚îú‚îÄ‚îÄ test_sublayers*.py
‚îú‚îÄ‚îÄ test_encoderlayers*.py
‚îú‚îÄ‚îÄ test_decoderlayers*.py
‚îú‚îÄ‚îÄ test_transformers\*.py
‚îú‚îÄ‚îÄ test_hw4p1.py
‚îî‚îÄ‚îÄ test_decoding.py

```

command to run:
```
cd D:\ahYen Workspace\ahYen Work\CMU_academic\MSCD_Y1_2425\11785-Intro to DL\IDL-HW4
python -m tests.test_mytorch
```

## Setup

Follow the setup instructions based on your preferred environment!

### Local

One of our key goals in designing this assignment is to allow you to complete most of the preliminary implementation work locally.  
We highly recommend that you **pass all tests locally** using the provided `hw4_data_subset` before moving to a GPU runtime.  
To do this, simply:

#### Step 1: Create a new conda environment

```bash
# Be sure to deactivate any active environments first
conda create -n hw4 python=3.12.4
```

#### Step 2: Activate the conda environment

```bash
conda activate hw4
```

#### Step 3: Install the dependencies using the provided `requirements.txt`

```bash
pip install --no-cache-dir --ignore-installed -r requirements.txt
```

#### Step 4: Ensure that your notebook is in the same working directory as the `Handout`

This can be achieved by:

1. Physically moving the notebook into the handout directory.
2. Changing the notebook‚Äôs current working directory to the handout directory using the os.chdir() function.

#### Step 5: Open the notebook and select the newly created environment from the kernel selector.

If everything was done correctly, You should see atleast the following files in your current working directory after running `!ls`:

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ hw4lib/
‚îú‚îÄ‚îÄ mytorch/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ hw4_data_subset/
```

### Colab

#### Step 1: Get your handout

- See writeup for recommended approaches.

##### Example: My preferred approach

```python
import os

# Settings -> Developer Settings -> Personal Access Tokens -> Token (classic)
os.environ['GITHUB_TOKEN'] = "your-token"

GITHUB_USERNAME = "your-username"
REPO_NAME = "IDL-HW4"
TOKEN = os.environ.get("GITHUB_TOKEN")
repo_url = f"https://{TOKEN}@github.com/{GITHUB_USERNAME}/{REPO_NAME}.git"
!git clone {repo_url}

## -------------

# To pull latest changes (Must be in the repo dir, use pwd/ls to verify)
!cd {REPO_NAME} && git pull
```

#### Step 2: Install Dependencies

- `NOTE`: Your runtime will be restarted to ensure all dependencies are updated.
- `NOTE`: You will see a runtime crashed message, this was intentionally done. Simply move on to the next cell.

```python
%pip install --no-deps -r IDL-HW4/requirements.txt
import os
# NOTE: This will restart the your colab Python runtime (required)!
os.kill(os.getpid(), 9)
```

#### Step 3: Obtain Data

- `NOTE`: This process will automatically download and unzip data for both `HW4P1` and `HW4P2`.

```bash
!curl -L -o /content/s25-hw4-data.zip https://www.kaggle.com/api/v1/datasets/download/cmu11785/s25-hw4-data
!unzip -q -o /content/s25-hw4-data.zip -d /content/hw4_data
!rm -rf /content/s25-hw4-data.zip
!du -h --max-depth=2 /content/hw4_data
```

#### Step 4: Move to Handout Directory

```python
import os
os.chdir('IDL-HW4')
!ls
```

You must be within the handout directory for the library imports to work!

- `NOTE`: You may have to repeat running this command anytime you restart your runtime.
- `NOTE`: You can do a `pwd` to check if you are in the right directory.
- `NOTE`: The way it is setup currently, Your data directory should be one level up from your project directory. Keep this in mind when you are setting your `root` in the config file.

If everything was done correctly, You should see atleast the following files in your current working directory after running `!ls`:

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ hw4lib/
‚îú‚îÄ‚îÄ mytorch/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ hw4_data_subset/
```

### Kaggle

While it is possible to run the notebook on Kaggle, we would recommend against it. This assignment is more resource intensive and may run slower on Kaggle.

#### Step 1: Get your handout

- See writeup for recommended approaches.

##### Example: My preferred approach

```python
import os

# Settings -> Developer Settings -> Personal Access Tokens -> Token (classic)
os.environ['GITHUB_TOKEN'] = "your-token"

GITHUB_USERNAME = "your-username"
REPO_NAME = "IDL-HW4"
TOKEN = os.environ.get("GITHUB_TOKEN")
repo_url = f"https://{TOKEN}@github.com/{GITHUB_USERNAME}/{REPO_NAME}.git"
!git clone {repo_url}

## -------------

# To pull latest changes (Must be in the repo dir, use pwd/ls to verify)
!cd {REPO_NAME} && git pull
```

#### Step 2: Install Dependencies

Simply set the `Environment` setting in the notebook to `Always use latest environment`. No need to install anything.

#### Step 3: Obtain Data

##### ‚ö†Ô∏è Important: Kaggle Users

If you are using Kaggle, **do not manually download the data!** The dataset is large and may exceed your available disk space. Instead, follow these steps to add the dataset directly to your notebook:

1. Open your **Kaggle Notebook**.
2. Navigate to **Notebook ‚Üí Input**.
3. Click **Add Input**.
4. In the search bar, paste the following URL:

üëâ [https://www.kaggle.com/datasets/cmu11785/s25-hw4-data](https://www.kaggle.com/datasets/cmu11785/s25-hw4-data)

5. Click the **‚ûï (plus sign)** to add the dataset to your notebook.

##### üìå Note:

This process will automatically download and unzip data for both `HW4P1` and `HW4P2`.

#### Step 4: Move to Handout Directory

```python
import os
os.chdir('IDL-HW4')
!ls
```

You must be within the handout directory for the library imports to work!

- `NOTE`: You may have to repeat running this command anytime you restart your runtime.
- `NOTE`: You can do a `pwd` to check if you are in the right directory.
- `NOTE`: The way it is setup currently, Your data directory should be one level up from your project directory. Keep this in mind when you are setting your `root` in the config file.

If everything was done correctly, You should see atleast the following files in your current working directory after running `!ls`:

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ hw4lib/
‚îú‚îÄ‚îÄ mytorch/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ hw4_data_subset/
```

### PSC

#### Step 1: Get your handout

- See writeup for recommended approaches.
- If you use Remote - SSH to connect to Bridges2, you can upload the handout to your project directory and work from there.

##### Example: My preferred approach

```python
import os

# Settings -> Developer Settings -> Personal Access Tokens -> Token (classic)
os.environ['GITHUB_TOKEN'] = "your-token"

GITHUB_USERNAME = "your-username"
REPO_NAME = "IDL-HW4"
TOKEN = os.environ.get("GITHUB_TOKEN")
repo_url = f"https://{TOKEN}@github.com/{GITHUB_USERNAME}/{REPO_NAME}.git"
!git clone {repo_url}

## -------------

# To pull latest changes (Must be in the repo dir, use pwd/ls to verify)
!cd {REPO_NAME} && git pull
```

#### Step 2: Setting Up Your Environment on Bridges2

For this homework, we are providing a shared Conda environment for the entire class. Follow these steps to set up the environment and start a Jupyter notebook on Bridges2:

##### 1. SSH into Bridges2

```bash
ssh username@bridges2.psc.edu
```

##### 2. Navigate to your Project Directory

```bash
cd $PROJECT
```

##### 3. Load the Anaconda Module

```bash
module load anaconda3
```

##### 4. Activate the provided HW4 Environment

```bash
# First, deactivate any existing Conda environment
conda deactivate
conda activate /jet/home/psamal/hw_envs/idl_hw4
```

##### 5. Request a Compute Node

```bash
interact -p GPU-shared --gres=gpu:v100-32:1 -t 8:00:00
```

##### 6. Re-activate Environment

If your Conda environment was deactivated due to node allocation:

```bash
# First, deactivate any existing Conda environment
conda deactivate
conda activate /jet/home/psamal/hw_envs/idl_hw4
```

##### 7. Start Jupyter Notebook

```bash
jupyter notebook --no-browser --ip=0.0.0.0
```

##### 8. Connect to Jupyter Server

You can now use your prefered way of connecting to the Jupyter Server. Your options should be covered in the docs linked in post 558 @ piazza.

The following is my preferred way of connecting to the Jupyter Server:

###### 8.1 Connect in VSCode

I prefer uploading the notebook to PSC Bridges2 storage ($PROJECT directory) and then connecting to the Jupyter Server from there.

1. Use Remote - SSH to connect to Bridges2 and navigate to your project directory.

2. Upload the notebook to the project directory.

3. Open the notebook in VSCode.

4. Go to **Kernel** ‚Üí **Select Another Kernel** ‚Üí **Existing Jupyter Server**

5. Enter the URL of the Jupyter Server:`http://{hostname}:{port}/tree?token={token}`

- eg: `http://v011.ib.bridges2.psc.edu:8888/tree?token=e4b302434e68990f28bc2b4ae8d216eb87eecb7090526249`

> **Note**: Replace `{hostname}`, `{port}` and `{token}` with your actual values from the Jupyter output.

#### Step 3: Get Data

- `NOTE`: This will download and unzip data for both `HW4P1` and `HW4P2`
- `NOTE`: We are using `$LOCAL`: the scratch storage on local disk on the node running a job to store out data.
  - Disk accesses are much faster than what you would get from `$PROJECT` storage
  - `IT IS NOT PERSISTENT`
- `NOTE`: Make sure you have completed the previous steps before running this cell.
- Read more about it PSC File Spaces [here](https://www.psc.edu/resources/bridges-2/user-guide#file-spaces).

```bash
!curl -L -o $LOCAL/s25-hw4-data.zip https://www.kaggle.com/api/v1/datasets/download/cmu11785/s25-hw4-data
!unzip -q -o $LOCAL/s25-hw4-data.zip -d $LOCAL/hw4_data
!rm -rf $LOCAL/s25-hw4-data.zip
!du -h --max-depth=2 $LOCAL/hw4_data
```

#### Step 4: Move to Handout Directory

Depending on the way you are running your notebook, you may or may not need to run this cell. As long as you are within the handout directory for the library imports to work!

```python
# Move to the handout directory if you are not there already
import os
os.chdir('IDL-HW4')
!ls
```

- `NOTE`: You may have to repeat running this command anytime you restart your runtime.
- `NOTE`: You can do a `pwd` to check if you are in the right directory.
- `NOTE`: The way it is setup currently, Your data directory should be one level up from your project directory. Keep this in mind when you are setting your `root` in the config file.

If everything was done correctly, You should see atleast the following files in your current working directory after running `!ls`:

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ hw4lib/
‚îú‚îÄ‚îÄ mytorch/
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ hw4_data_subset/
```

---
## Notes for setup PSC:
# ‰ΩøÁî®PSC Bridges2ËøõË°åGPUËÆ°ÁÆóÁöÑÊ≠•È™§ÊåáÂçó

‰ª•‰∏ãÊòØÂú®PSC Bridges2‰∏äËÆæÁΩÆÂíå‰ΩøÁî®GPUËµÑÊ∫êËøõË°åÊ∑±Â∫¶Â≠¶‰π†‰ªªÂä°ÁöÑÂÆåÊï¥Ê≠•È™§ÊåáÂçó„ÄÇ

## Á¨¨‰∏ÄÊ≠•ÔºöSSHÁôªÂΩïÂπ∂ËÆæÁΩÆ‰∫§‰∫íÂºè‰ºöËØù

**ÁªàÁ´Ø1Ôºö**
```bash
# 1. SSHÁôªÂΩïÂà∞Bridges2
ssh hchia@bridges2.psc.edu

# 2. ÊøÄÊ¥ªÈ¢ÑËÆæÁöÑcondaÁéØÂ¢É
conda activate /jet/home/psamal/hw_envs/idl_hw4

# 3. ËØ∑Ê±Ç‰∫§‰∫íÂºèGPU‰ºöËØù
interact -p GPU-shared --gres=gpu:v100-32:1 -t 8:00:00

# 4. ÁßªÂä®Âà∞‰Ω†ÁöÑÈ°πÁõÆÁõÆÂΩï
# need to be conda in (activate /jet/home/psamal/hw_envs/idl_hw4) deactivate (base)
cd /ocean/projects/cis250019p/hchia/

# 5. ÂêØÂä®JupyterÊúçÂä°Âô®
jupyter notebook --no-browser --ip=0.0.0.0
```

Ê≠§Êó∂ÁªàÁ´Ø‰ºöÊòæÁ§∫‰∏Ä‰∏™JupyterÊúçÂä°Âô®URLÔºåÂÖ∂‰∏≠ÂåÖÂê´token‰ø°ÊÅØÔºåÁ±ª‰ººÔºö
`http://v<017>.ib.bridges2.psc.edu:8888/tree?token=196273168a80b29fea12bc85e4967228a09ef76313e7a69c`

## Á¨¨‰∫åÊ≠•ÔºöËÆæÁΩÆSSHÁ´ØÂè£ËΩ¨Âèë

**ÁªàÁ´Ø2Ôºö**
```bash
# Âú®Êú¨Âú∞ËÆ°ÁÆóÊú∫ÊâìÂºÄÊñ∞ÁªàÁ´ØÔºåËÆæÁΩÆSSHÁ´ØÂè£ËΩ¨Âèë
# ÊõøÊç¢v017‰∏∫ÂÆûÈôÖÂàÜÈÖçÁöÑËäÇÁÇπÂêç
ssh -L 8888:v010.ib.bridges2.psc.edu:8888 hchia@bridges2.psc.edu

```
Ëøô‰∏™ÁªàÁ´ØÁ™óÂè£ÈúÄË¶Å‰∏ÄÁõ¥‰øùÊåÅÊâìÂºÄÁä∂ÊÄÅ„ÄÇ

## Á¨¨‰∏âÊ≠•Ôºö‰∏ä‰º†Êñá‰ª∂ÔºàÂ¶ÇÈúÄÔºâ

**ÁªàÁ´Ø3Ôºö**
```bash
# ‰ªéÊú¨Âú∞‰∏ä‰º†Êñá‰ª∂Âà∞ÊúçÂä°Âô®ÔºàÊ†πÊçÆÈúÄË¶ÅÔºâ
scp "Êú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑ" Áî®Êà∑Âêç@bridges2.psc.edu:/ocean/projects/cis250019p/Áî®Êà∑Âêç/Êñá‰ª∂Âêç
```

## Á¨¨ÂõõÊ≠•ÔºöËÆøÈóÆJupyterÂπ∂ÂºÄÂßãÂ∑•‰Ωú

1. Âú®Êú¨Âú∞ÊµèËßàÂô®‰∏≠ËÆøÈóÆÔºö`http://localhost:8888/`
2. ËæìÂÖ•tokenÔºà‰ªéÁªàÁ´Ø1‰∏≠Â§çÂà∂Ôºâ
3. ÊåâÁÖßnotebookÊåáÁ§∫ËøêË°å‰ª£Á†ÅÔºö
   - ÂÖãÈöÜGitHub‰ª£Á†ÅÂ∫ì
   - ‰∏ãËΩΩÊï∞ÊçÆÈõÜÂà∞`$LOCAL`ÁõÆÂΩï
   - ÂÆûÁé∞ÊâÄÈúÄÁªÑ‰ª∂
   - ËÆ≠ÁªÉÊ®°Âûã
   - ÁîüÊàêÁªìÊûúÂπ∂Êèê‰∫§

## ÈáçË¶ÅÊ≥®ÊÑè‰∫ãÈ°π

1. **Ë∑ØÂæÑÂå∫Âà´Ôºö**
   - `$LOCAL`Ôºö‰∏¥Êó∂Â≠òÂÇ®ÔºåÈÄüÂ∫¶Âø´Ôºå‰ªªÂä°ÁªìÊùüÂêéÂà†Èô§
   - `/ocean/projects/...`ÔºöÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåÈÄÇÂêà‰ª£Á†ÅÂíåÁªìÊûú

2. **ËµÑÊ∫êÈôêÂà∂Ôºö**
   - ‰∫§‰∫íÂºè‰ºöËØùÊúâÊó∂Èó¥ÈôêÂà∂Ôºà‰æãÂ¶Ç8Â∞èÊó∂Ôºâ
   - ÂèäÊó∂‰øùÂ≠òÂ∑•‰Ωú
   - ËÆ∞‰Ωètoken‰ºöÂú®ÊØèÊ¨°ÈáçÂêØJupyterÊó∂ÊîπÂèò

3. **Êìç‰ΩúÈ°∫Â∫èÔºö**
   - ÁªàÁ´Ø1ÂêØÂä®JupyterÊúçÂä°Âô®
   - ÁªàÁ´Ø2Âª∫Á´ãÁ´ØÂè£ËΩ¨ÂèëÔºà‰øùÊåÅËøêË°åÔºâ
   - ÁªàÁ´Ø3Áî®‰∫éÊñá‰ª∂‰º†ËæìÔºàÊåâÈúÄÔºâ
   - ÊµèËßàÂô®ËÆøÈóÆÊú¨Âú∞Á´ØÂè£`localhost:8888`

ÊåâÁÖßËøô‰∫õÊ≠•È™§Ôºå‰Ω†ÂèØ‰ª•ÂÖÖÂàÜÂà©Áî®PSC Bridges2‰∏äÁöÑGPUËµÑÊ∫êËøõË°åÊ∑±Â∫¶Â≠¶‰π†‰ªªÂä°„ÄÇ